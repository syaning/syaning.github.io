import{_ as s,o as a,c as n,V as o}from"./chunks/framework.16eef3c0.js";const i=JSON.parse('{"title":"Node","description":"","frontmatter":{},"headers":[],"relativePath":"notes/kubernetes/resources/node.md"}'),l={name:"notes/kubernetes/resources/node.md"},p=o(`<h1 id="node" tabindex="-1">Node <a class="header-anchor" href="#node" aria-label="Permalink to &quot;Node&quot;">​</a></h1><h2 id="简介" tabindex="-1">简介 <a class="header-anchor" href="#简介" aria-label="Permalink to &quot;简介&quot;">​</a></h2><p>通过如下方式可以查看集群的节点信息：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">kubectl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">get</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">node</span></span>
<span class="line"><span style="color:#FFCB6B;">NAME</span><span style="color:#A6ACCD;">      </span><span style="color:#C3E88D;">STATUS</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">ROLES</span><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">AGE</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">VERSION</span></span>
<span class="line"><span style="color:#82AAFF;">test</span><span style="color:#FFCB6B;">-01</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">Ready</span><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">master</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">38d</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">v1.</span><span style="color:#F78C6C;">15.0</span></span>
<span class="line"><span style="color:#82AAFF;">test</span><span style="color:#FFCB6B;">-02</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">Ready</span><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">non</span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">38d</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">v1.</span><span style="color:#F78C6C;">15.0</span></span>
<span class="line"><span style="color:#82AAFF;">test</span><span style="color:#FFCB6B;">-03</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">Ready</span><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">non</span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">38d</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">v1.</span><span style="color:#F78C6C;">15.0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">kubectl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">get</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">node</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-owide</span></span>
<span class="line"><span style="color:#FFCB6B;">NAME</span><span style="color:#A6ACCD;">      </span><span style="color:#C3E88D;">STATUS</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">ROLES</span><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">AGE</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">VERSION</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">INTERNAL-IP</span><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">EXTERNAL-IP</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">OS-IMAGE</span><span style="color:#A6ACCD;">           </span><span style="color:#C3E88D;">KERNEL-VERSION</span><span style="color:#A6ACCD;">      </span><span style="color:#C3E88D;">CONTAINER-RUNTIME</span></span>
<span class="line"><span style="color:#82AAFF;">test</span><span style="color:#FFCB6B;">-01</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">Ready</span><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">master</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">38d</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">v1.</span><span style="color:#F78C6C;">15.0</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">10.40.57.233</span><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">non</span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">        </span><span style="color:#C3E88D;">Ubuntu</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">16.04</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">LTS</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">4.15.0-</span><span style="color:#F78C6C;">39</span><span style="color:#C3E88D;">-generic</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">docker://18.6.1</span></span>
<span class="line"><span style="color:#82AAFF;">test</span><span style="color:#FFCB6B;">-02</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">Ready</span><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">non</span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">38d</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">v1.</span><span style="color:#F78C6C;">15.0</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">10.40.57.71</span><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">non</span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">        </span><span style="color:#C3E88D;">Ubuntu</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">16.04</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">LTS</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">4.15.0-</span><span style="color:#F78C6C;">39</span><span style="color:#C3E88D;">-generic</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">docker://18.6.1</span></span>
<span class="line"><span style="color:#82AAFF;">test</span><span style="color:#FFCB6B;">-03</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">Ready</span><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">non</span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">38d</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">v1.</span><span style="color:#F78C6C;">15.0</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">10.40.57.77</span><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">non</span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">        </span><span style="color:#C3E88D;">Ubuntu</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">16.04</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">LTS</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">4.15.0-</span><span style="color:#F78C6C;">39</span><span style="color:#C3E88D;">-generic</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">docker://18.6.1</span></span></code></pre></div><p>Node 默认有如下标签：</p><ul><li><code>kubernetes.io/arch</code></li><li><code>kubernetes.io/hostname</code></li><li><code>kubernetes.io/os</code></li></ul><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">kubectl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">get</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">node</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">test-</span><span style="color:#F78C6C;">01</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-oyaml</span></span>
<span class="line"><span style="color:#FFCB6B;">apiVersion:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">v1</span></span>
<span class="line"><span style="color:#FFCB6B;">kind:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Node</span></span>
<span class="line"><span style="color:#FFCB6B;">metadata:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">labels:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">kubernetes.io/arch:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">amd64</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">kubernetes.io/hostname:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">test-</span><span style="color:#F78C6C;">01</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">kubernetes.io/os:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">linux</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">node-role.kubernetes.io/master:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">name:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">test-</span><span style="color:#F78C6C;">01</span></span>
<span class="line"><span style="color:#FFCB6B;">spec:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">podCIDR:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">10.244.0.0/</span><span style="color:#F78C6C;">24</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">taints:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">effect:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">NoSchedule</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">key:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">node-role.kubernetes.io/master</span></span></code></pre></div><h2 id="taint" tabindex="-1">Taint <a class="header-anchor" href="#taint" aria-label="Permalink to &quot;Taint&quot;">​</a></h2><p>详情参考 <a href="https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/" target="_blank" rel="noreferrer">Taints and Tolerations</a>。</p><p>Taint 是 Node 的特性，一般包含 <code>key</code>，<code>value</code> 和 <code>effect</code>，表示形式为 <code>key=value:effect</code>。可以为 Node 打上 taint，以及一定的副作用。通过 <code>kubectl taint</code> 命令可以为 Node 添加或者删除 taint，例如：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># 添加 taint</span></span>
<span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">kubectl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">taint</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">node</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">node-</span><span style="color:#F78C6C;">01</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">dedicated=special-user:NoSchedule</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 删除 taint</span></span>
<span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">kubectl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">taint</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">node</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">node-</span><span style="color:#F78C6C;">01</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">dedicated:NoSchedule-</span></span></code></pre></div><p>在上一部分的例子中，master 节点默认 taint 如下：</p><div class="language-yaml"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">taints</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">effect</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">NoSchedule</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">key</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">node-role.kubernetes.io/master</span></span></code></pre></div><p>通常默认情况下，master 节点是不允许调度 Pod 的，如果希望 master 节点也可以调度 Pod，可以执行：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">kubectl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">taint</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nodes</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--all</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">node-role.kubernetes.io/master-</span></span></code></pre></div><p>effect 的取值为：</p><ul><li><code>NoSchedule</code>：禁止调度</li><li><code>PreferNoSchedule</code>：优先不调度</li><li><code>NoExecute</code>：不调度到该节点，同时会驱逐已经调度到该节点的 Pod</li></ul><h2 id="管理" tabindex="-1">管理 <a class="header-anchor" href="#管理" aria-label="Permalink to &quot;管理&quot;">​</a></h2><h3 id="cordon-uncordon" tabindex="-1">cordon / uncordon <a class="header-anchor" href="#cordon-uncordon" aria-label="Permalink to &quot;cordon / uncordon&quot;">​</a></h3><p><code>cordon</code> 将节点标记为不可调度；<code>uncordon</code> 将节点重新标记为可调度。</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">kubectl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">cordon</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">test-</span><span style="color:#F78C6C;">03</span></span>
<span class="line"><span style="color:#FFCB6B;">NAME</span><span style="color:#A6ACCD;">      </span><span style="color:#C3E88D;">STATUS</span><span style="color:#A6ACCD;">                     </span><span style="color:#C3E88D;">ROLES</span><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">AGE</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">VERSION</span></span>
<span class="line"><span style="color:#82AAFF;">test</span><span style="color:#FFCB6B;">-01</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">Ready</span><span style="color:#A6ACCD;">                      </span><span style="color:#C3E88D;">master</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">45d</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">v1.</span><span style="color:#F78C6C;">15.0</span></span>
<span class="line"><span style="color:#82AAFF;">test</span><span style="color:#FFCB6B;">-02</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">Ready</span><span style="color:#A6ACCD;">                      </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">non</span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">45d</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">v1.</span><span style="color:#F78C6C;">15.0</span></span>
<span class="line"><span style="color:#82AAFF;">test</span><span style="color:#FFCB6B;">-03</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">Ready,SchedulingDisabled</span><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">non</span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">45d</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">v1.</span><span style="color:#F78C6C;">15.0</span></span></code></pre></div><h3 id="drain" tabindex="-1">drain <a class="header-anchor" href="#drain" aria-label="Permalink to &quot;drain&quot;">​</a></h3><p>如果需要将一个 Node 从集群中移除，则需要先执行 <code>kubectl drain &lt;node name&gt;</code> 操作。该操作会：</p><ul><li>标记该 Node 为不可调度 (<code>kubectl cordon &lt;node name&gt;</code>)</li><li>驱逐该 Node 上的 Pod</li></ul><p>通过 <code>--ignore-daemonsets</code> 可以忽略 DaemonSet；如果有 Pod 使用本地存储，例如 <code>emptyDir</code>，可以使用 <code>--delete-local-data</code> 参数。</p><p><code>drain</code> 操作结束后，即可将 Node 从集群中移除。如果想要 Node 继续使用，可以通过 <code>kubectl uncordon &lt;node name&gt;</code>.</p><p>该操作在驱逐 Pod 的时候，会遵循 <a href="./pod-disruption-budget.html">PodDisruptionBudget</a></p><h2 id="参考" tabindex="-1">参考 <a class="header-anchor" href="#参考" aria-label="Permalink to &quot;参考&quot;">​</a></h2><ul><li><a href="https://kubernetes.io/docs/concepts/architecture/nodes/" target="_blank" rel="noreferrer">Nodes</a></li><li><a href="https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/" target="_blank" rel="noreferrer">Taints and Tolerations</a></li><li><a href="https://kubernetes.io/docs/tasks/administer-cluster/safely-drain-node/" target="_blank" rel="noreferrer">Safely Drain a Node while Respecting the PodDisruptionBudget</a></li></ul>`,29),e=[p];function t(c,r,C,y,A,D){return a(),n("div",null,e)}const F=s(l,[["render",t]]);export{i as __pageData,F as default};
