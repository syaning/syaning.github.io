import{_ as s,o as n,c as a,V as l}from"./chunks/framework.16eef3c0.js";const F=JSON.parse('{"title":"Deployment","description":"","frontmatter":{},"headers":[],"relativePath":"note/kubernetes/resources/deployment.md"}'),p={name:"note/kubernetes/resources/deployment.md"},o=l(`<h1 id="deployment" tabindex="-1">Deployment <a class="header-anchor" href="#deployment" aria-label="Permalink to &quot;Deployment&quot;">​</a></h1><h2 id="创建-deployment" tabindex="-1">创建 Deployment <a class="header-anchor" href="#创建-deployment" aria-label="Permalink to &quot;创建 Deployment&quot;">​</a></h2><div class="language-yaml"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F07178;">apiVersion</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">apps/v1</span></span>
<span class="line"><span style="color:#F07178;">kind</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Deployment</span></span>
<span class="line"><span style="color:#F07178;">metadata</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span>
<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">replicas</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">selector</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">matchLabels</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">app</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">template</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">metadata</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">labels</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">app</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">containers</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx:1.16</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">ports</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">containerPort</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">80</span></span></code></pre></div><p>Deployment 会自动创建 ReplicaSet：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">kubectl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">get</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">deploy</span></span>
<span class="line"><span style="color:#FFCB6B;">NAME</span><span style="color:#A6ACCD;">      </span><span style="color:#C3E88D;">DESIRED</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">CURRENT</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">UP-TO-DATE</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">AVAILABLE</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">AGE</span></span>
<span class="line"><span style="color:#FFCB6B;">nginx</span><span style="color:#A6ACCD;">     </span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">         </span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">         </span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">            </span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">           </span><span style="color:#C3E88D;">4s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">kubectl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">get</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">rs</span></span>
<span class="line"><span style="color:#FFCB6B;">NAME</span><span style="color:#A6ACCD;">               </span><span style="color:#C3E88D;">DESIRED</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">CURRENT</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">READY</span><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">AGE</span></span>
<span class="line"><span style="color:#FFCB6B;">nginx-65fc954674</span><span style="color:#A6ACCD;">   </span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">         </span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">         </span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">         </span><span style="color:#C3E88D;">12s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">kubectl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">get</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">po</span></span>
<span class="line"><span style="color:#FFCB6B;">NAME</span><span style="color:#A6ACCD;">                     </span><span style="color:#C3E88D;">READY</span><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">STATUS</span><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">RESTARTS</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">AGE</span></span>
<span class="line"><span style="color:#FFCB6B;">nginx-65fc954674-2tc4v</span><span style="color:#A6ACCD;">   </span><span style="color:#F78C6C;">1</span><span style="color:#C3E88D;">/</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">       </span><span style="color:#C3E88D;">Running</span><span style="color:#A6ACCD;">   </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">          </span><span style="color:#C3E88D;">15s</span></span>
<span class="line"><span style="color:#FFCB6B;">nginx-65fc954674-fmqpf</span><span style="color:#A6ACCD;">   </span><span style="color:#F78C6C;">1</span><span style="color:#C3E88D;">/</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">       </span><span style="color:#C3E88D;">Running</span><span style="color:#A6ACCD;">   </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">          </span><span style="color:#C3E88D;">15s</span></span>
<span class="line"><span style="color:#FFCB6B;">nginx-65fc954674-ssz7x</span><span style="color:#A6ACCD;">   </span><span style="color:#F78C6C;">1</span><span style="color:#C3E88D;">/</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">       </span><span style="color:#C3E88D;">Running</span><span style="color:#A6ACCD;">   </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">          </span><span style="color:#C3E88D;">15s</span></span></code></pre></div><h2 id="扩容" tabindex="-1">扩容 <a class="header-anchor" href="#扩容" aria-label="Permalink to &quot;扩容&quot;">​</a></h2><h3 id="手动扩容" tabindex="-1">手动扩容 <a class="header-anchor" href="#手动扩容" aria-label="Permalink to &quot;手动扩容&quot;">​</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">kubectl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">scale</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--replicas=5</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">deploy/nginx</span></span></code></pre></div><h3 id="自动扩容" tabindex="-1">自动扩容 <a class="header-anchor" href="#自动扩容" aria-label="Permalink to &quot;自动扩容&quot;">​</a></h3><p>参考 <a href="./horizontal-pod-autoscaler.html">HorizontalPodAutoscaler</a>。</p><h2 id="滚动升级" tabindex="-1">滚动升级 <a class="header-anchor" href="#滚动升级" aria-label="Permalink to &quot;滚动升级&quot;">​</a></h2><h3 id="升级" tabindex="-1">升级 <a class="header-anchor" href="#升级" aria-label="Permalink to &quot;升级&quot;">​</a></h3><p>只有当 Deployment 中 Pod 的模板发生改变时，才会触发升级，即 <code>spec.template</code> 发生变化。例如修改镜像为 <code>nginx:1.17.2</code>：</p><div class="language-yaml"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F07178;">apiVersion</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">apps/v1</span></span>
<span class="line"><span style="color:#F07178;">kind</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Deployment</span></span>
<span class="line"><span style="color:#F07178;">metadata</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span>
<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">replicas</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">selector</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">matchLabels</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">app</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">template</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">metadata</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">labels</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">app</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">containers</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx:1.17.2</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">ports</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">containerPort</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">80</span></span></code></pre></div><p>然后进行查看：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">kubectl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">get</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">deploy</span></span>
<span class="line"><span style="color:#FFCB6B;">NAME</span><span style="color:#A6ACCD;">      </span><span style="color:#C3E88D;">DESIRED</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">CURRENT</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">UP-TO-DATE</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">AVAILABLE</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">AGE</span></span>
<span class="line"><span style="color:#FFCB6B;">nginx</span><span style="color:#A6ACCD;">     </span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">         </span><span style="color:#F78C6C;">4</span><span style="color:#A6ACCD;">         </span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">            </span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">           </span><span style="color:#C3E88D;">48s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">kubectl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">get</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">rs</span></span>
<span class="line"><span style="color:#FFCB6B;">NAME</span><span style="color:#A6ACCD;">               </span><span style="color:#C3E88D;">DESIRED</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">CURRENT</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">READY</span><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">AGE</span></span>
<span class="line"><span style="color:#FFCB6B;">nginx-56b7d6bcf7</span><span style="color:#A6ACCD;">   </span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">         </span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">         </span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">         </span><span style="color:#C3E88D;">10s</span></span>
<span class="line"><span style="color:#FFCB6B;">nginx-65fc954674</span><span style="color:#A6ACCD;">   </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">         </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">         </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">         </span><span style="color:#C3E88D;">51s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">kubectl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">get</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">po</span></span>
<span class="line"><span style="color:#FFCB6B;">NAME</span><span style="color:#A6ACCD;">                     </span><span style="color:#C3E88D;">READY</span><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">STATUS</span><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">RESTARTS</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">AGE</span></span>
<span class="line"><span style="color:#FFCB6B;">nginx-56b7d6bcf7-2jhsm</span><span style="color:#A6ACCD;">   </span><span style="color:#F78C6C;">1</span><span style="color:#C3E88D;">/</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">       </span><span style="color:#C3E88D;">Running</span><span style="color:#A6ACCD;">   </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">          </span><span style="color:#C3E88D;">11s</span></span>
<span class="line"><span style="color:#FFCB6B;">nginx-56b7d6bcf7-dxkf5</span><span style="color:#A6ACCD;">   </span><span style="color:#F78C6C;">1</span><span style="color:#C3E88D;">/</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">       </span><span style="color:#C3E88D;">Running</span><span style="color:#A6ACCD;">   </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">          </span><span style="color:#C3E88D;">15s</span></span>
<span class="line"><span style="color:#FFCB6B;">nginx-56b7d6bcf7-q6jss</span><span style="color:#A6ACCD;">   </span><span style="color:#F78C6C;">1</span><span style="color:#C3E88D;">/</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">       </span><span style="color:#C3E88D;">Running</span><span style="color:#A6ACCD;">   </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">          </span><span style="color:#C3E88D;">13s</span></span></code></pre></div><p>可以看到，更新之后，会生成一个新的 ReplicaSet。</p><p>查看升级状态：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">kubectl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">rollout</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">status</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">deploy/nginx</span></span>
<span class="line"><span style="color:#FFCB6B;">deployment</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">nginx</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">successfully</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">rolled</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">out</span></span></code></pre></div><p>查看 Deployment 的滚动升级详情：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">kubectl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">describe</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">deploy</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span>
<span class="line"><span style="color:#82AAFF;">......</span></span>
<span class="line"><span style="color:#FFCB6B;">Events:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">Type</span><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">Reason</span><span style="color:#A6ACCD;">             </span><span style="color:#C3E88D;">Age</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">From</span><span style="color:#A6ACCD;">                   </span><span style="color:#C3E88D;">Message</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">----</span><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">------</span><span style="color:#A6ACCD;">             </span><span style="color:#C3E88D;">----</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">----</span><span style="color:#A6ACCD;">                   </span><span style="color:#C3E88D;">-------</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">Normal</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">ScalingReplicaSet</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">3m</span><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">deployment-controller</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">Scaled</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">up</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">replica</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">set</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx-65fc954674</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">to</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">Normal</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">ScalingReplicaSet</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">2m</span><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">deployment-controller</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">Scaled</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">up</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">replica</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">set</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx-56b7d6bcf7</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">to</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">Normal</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">ScalingReplicaSet</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">2m</span><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">deployment-controller</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">Scaled</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">down</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">replica</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">set</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx-65fc954674</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">to</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">Normal</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">ScalingReplicaSet</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">2m</span><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">deployment-controller</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">Scaled</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">up</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">replica</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">set</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx-56b7d6bcf7</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">to</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">Normal</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">ScalingReplicaSet</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">2m</span><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">deployment-controller</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">Scaled</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">down</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">replica</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">set</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx-65fc954674</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">to</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">Normal</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">ScalingReplicaSet</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">2m</span><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">deployment-controller</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">Scaled</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">up</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">replica</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">set</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx-56b7d6bcf7</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">to</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">Normal</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">ScalingReplicaSet</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">2m</span><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">deployment-controller</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">Scaled</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">down</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">replica</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">set</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx-65fc954674</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">to</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span></span></code></pre></div><h3 id="升级历史" tabindex="-1">升级历史 <a class="header-anchor" href="#升级历史" aria-label="Permalink to &quot;升级历史&quot;">​</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">kubectl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">rollout</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">history</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">deploy/nginx</span></span>
<span class="line"><span style="color:#FFCB6B;">deployments</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">nginx</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#FFCB6B;">REVISION</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">CHANGE-CAUSE</span></span>
<span class="line"><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">         </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">none</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">         </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">none</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">kubectl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">rollout</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">history</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">deploy/nginx</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--revision=2</span></span>
<span class="line"><span style="color:#FFCB6B;">deployments</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">nginx</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">with</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">revision</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#2</span></span>
<span class="line"><span style="color:#FFCB6B;">Pod</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Template:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">Labels:</span><span style="color:#A6ACCD;">	</span><span style="color:#C3E88D;">app=nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#FFCB6B;">pod-template-</span><span style="color:#82AAFF;">hash</span><span style="color:#FFCB6B;">=1263826793</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">Containers:</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#FFCB6B;">nginx:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Image:</span><span style="color:#A6ACCD;">	</span><span style="color:#C3E88D;">nginx:1.17.2</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Port:</span><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">80</span><span style="color:#C3E88D;">/TCP</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Host</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Port:	</span><span style="color:#F78C6C;">0</span><span style="color:#C3E88D;">/TCP</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Environment:</span><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">non</span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Mounts:</span><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">non</span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">Volumes:</span><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">non</span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">&gt;</span></span></code></pre></div><p><code>.spec.revisionHistoryLimit</code> 可以设置保留多少次升级历史，默认为 10。如果设置为 0，则不保留任何升级历史，因此也就无法执行回滚操作。</p><h3 id="回滚" tabindex="-1">回滚 <a class="header-anchor" href="#回滚" aria-label="Permalink to &quot;回滚&quot;">​</a></h3><p>修改 YAML 文件为上个版本，重新 apply，可以做回滚操作；或者</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># 回滚到上一版本</span></span>
<span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">kubectl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">rollout</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">undo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">deploy/nginx</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 回滚到指定版本</span></span>
<span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">kubectl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">rollout</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">undo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">deploy/nginx</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--to-revision=1</span></span></code></pre></div><h3 id="升级策略" tabindex="-1">升级策略 <a class="header-anchor" href="#升级策略" aria-label="Permalink to &quot;升级策略&quot;">​</a></h3><p><code>.spec.strategy</code> 可以设置升级策略，其中 <code>.spec.strategy.type</code> 可以取值为：</p><ul><li>Recreate：会直接 kill 掉已有 Pod，然后重新创建</li><li>RollingUpdate：滚动升级，默认策略。如果为该策略，还可以设置 <code>maxUnavailable</code> 和 <code>maxSurge</code> 来控制升级的过程</li></ul><p>更多详情参考 <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#strategy" target="_blank" rel="noreferrer">Strategy</a>。</p><h2 id="参考" tabindex="-1">参考 <a class="header-anchor" href="#参考" aria-label="Permalink to &quot;参考&quot;">​</a></h2><ul><li><a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" target="_blank" rel="noreferrer">Deployments</a></li></ul>`,33),e=[o];function t(c,C,r,y,D,A){return n(),a("div",null,e)}const E=s(p,[["render",t]]);export{F as __pageData,E as default};
